================================================================================
                        EXPLORATORY FACTOR ANALYSIS JOURNAL
                              Data Science Project Log
                                   January 30, 2026
================================================================================

PROJECT GOAL
------------
Understand what factors predict MARGIN in manufacturing/steel quote data.
Future goal: Test what affects CUSTOMER_TIER once that column is added.


DATASET
-------
File: NerdClustersSharedData_2026-01-12-1020.csv
Records: 1,000
Variables: 34 columns

Key numeric variables used:
  - LINEITEMUNITPRICE      (price per unit: $2.21 - $6,414.29)
  - LINEITEMTOTALPRICE     (total line price)
  - ESTIMATETOTALPRICE     (total estimate value)
  - ESTIMATETOTALQUANTITY  (quantity on estimate: 1 - 552)
  - QTYPERLINEITEM         (quantity per line: 1 - 520)
  - MATERIALUNITWEIGHT     (weight per unit: 1.88 - 8,168 lbs)
  - MATERIALCENTWEIGHTCOST (cost per hundredweight: $40 - $137)

Dependent Variable:
  - MARGINACTUAL (4% - 60%, 34 unique values)


================================================================================
                              METHODOLOGY: EFA WORKFLOW
================================================================================

WHAT IS EFA?
------------
Exploratory Factor Analysis discovers "latent factors" - hidden constructs that
explain why observed variables correlate with each other.

THE PIPELINE:
  IVs (measured) --> EFA --> Factors (latent) --> Regression --> DV (margin)

STEP-BY-STEP:

1. SELECT VARIABLES
   Chose 7 order characteristic variables as Independent Variables (IVs)
   Did NOT include margin variables (those are the DV we're predicting)

2. STANDARDIZE DATA
   Applied z-score normalization (mean=0, std=1) to put all variables on
   equal footing. Essential because variables have different scales
   (prices in hundreds vs. weights in thousands).

3. CHECK FACTORABILITY
   - Bartlett's Test: PASSED (p < 0.001) - data has correlations worth factoring
   - KMO: 0.462 (poor) - some variables don't share much variance with others

4. DETERMINE NUMBER OF FACTORS
   - Kaiser Criterion (eigenvalue > 1): Suggested 2 factors
   - Scree Plot: Confirmed 2-factor solution
   - Total variance explained: 65.9%

5. EXTRACT FACTORS WITH VARIMAX ROTATION
   Varimax makes factors "simple" - each variable loads high on one factor
   and low on others, making interpretation easier.

6. CALCULATE FACTOR SCORES
   Each of the 1,000 orders gets a score on each factor.
   These scores become the new predictors for regression.

7. REGRESS FACTORS ON MARGIN
   Used OLS regression: MARGINACTUAL ~ Factor1 + Factor2


================================================================================
                                 KEY FINDINGS
================================================================================

FACTOR STRUCTURE (2 FACTORS)
----------------------------

FACTOR 1: "ORDER VOLUME"
  - ESTIMATETOTALPRICE:     0.86 loading
  - ESTIMATETOTALQUANTITY:  0.84 loading
  - QTYPERLINEITEM:         0.76 loading
  - LINEITEMTOTALPRICE:     0.75 loading

  Interpretation: How BIG is the order? More quantity, higher totals.

FACTOR 2: "UNIT CHARACTERISTICS"
  - LINEITEMUNITPRICE:      1.00 loading
  - MATERIALUNITWEIGHT:     0.99 loading

  Interpretation: How EXPENSIVE/HEAVY is each unit? These two move together
  almost perfectly (r = 0.98) - heavier materials cost more per unit.

ORPHAN VARIABLE:
  - MATERIALCENTWEIGHTCOST: 0.02 loading (communality = 0.016)
  This variable doesn't fit either factor - it operates independently.


REGRESSION RESULTS
------------------

                    Coefficient   p-value    Significant?
  Factor 1 (Volume)    +0.11       0.740        NO
  Factor 2 (Unit)      -1.40      <0.001       YES (negative!)

  R-squared: 0.021 (only 2.1% of margin variance explained)


INTERPRETATION
--------------

1. ORDER VOLUME DOESN'T AFFECT MARGIN
   Big orders don't get better or worse margins than small orders.
   Quantity/size of order is not a factor in margin decisions.

2. UNIT CHARACTERISTICS NEGATIVELY PREDICT MARGIN
   Higher unit price / heavier materials --> LOWER margin percentage

   Possible explanations:
   - Premium materials face more competitive pressure
   - Cost-plus pricing with fixed markup (expensive items = lower %)
   - Commoditization of high-end materials

3. 97.9% OF MARGIN VARIANCE IS UNEXPLAINED
   Order characteristics barely predict margin!
   This suggests margin is driven by OTHER factors we didn't measure:
   - Customer relationships / tier
   - Sales rep discretion
   - Competitive bidding situations
   - Urgency / lead time
   - Geographic factors


================================================================================
                               VISUAL OUTPUTS
================================================================================

Generated files in outputs/ directory:
  - correlation_matrix.png   : Heatmap showing variable correlations
  - scree_plot.png          : Eigenvalues for determining # of factors
  - factor_loadings.png     : Heatmap of variable-factor relationships
  - path_diagram.png        : IVs --> Factors --> DV flow diagram
  - factor_loadings.csv     : Raw loading values
  - communalities.csv       : Variance explained per variable
  - factor_scores.csv       : Factor scores for all 1,000 observations


================================================================================
                                 NEXT STEPS
================================================================================

1. ADD CUSTOMER_TIER COLUMN
   Test whether tier is a better predictor of margin than order characteristics.
   Hypothesis: Customer tier will explain significantly more variance.

2. EXPLORE PRICING BEHAVIOR
   Dig deeper into the negative unit characteristics --> margin relationship.
   Is this by design (pricing strategy) or an anomaly?

3. INVESTIGATE ORDER COMPLEXITY
   Add more variables: SHAPEGROUP, MATERIALTYPE, number of line items.
   These categorical variables might reveal margin patterns.

4. CONSIDER MIXED-EFFECTS MODEL
   If data has hierarchical structure (orders within customers),
   a mixed model might be more appropriate than simple OLS.


================================================================================
                              TECHNICAL NOTES
================================================================================

Python Environment:
  - Python 3.13
  - factor-analyzer 0.5.1
  - scikit-learn 1.6.1
  - statsmodels 0.14.6
  - pandas 3.0.0

Key Files:
  - efa_analysis.py                  : Original EFA → Margin analysis
  - efa_price_tier.py                : EFA → Price Tier analysis (NEW)
  - price_tier_validation.py         : Random Forest tier validation (NEW)
  - price_tier_validation_hybrid.py  : Hybrid EFA + RF validation (NEW)
  - plot_path_diagram.py             : Path diagram visualization
  - requirements.txt                 : Dependencies

Documentation Files:
  - CLAUDE.md                        : Data schema (auto-loaded)
  - DataJournal.txt                  : Analysis history (this file)
  - Initial Price Tier Findings.txt  : RF methodology explained
  - Hybrid Methodology Explained.txt : EFA + RF hybrid approach

Data Limitations Encountered:
  - Initial dataset (73 records) had singular matrix issues due to
    perfectly correlated variables (QTY was always 1)
  - Switched to larger dataset (1,000 records) with varying quantities
  - KMO still poor (0.462) - variables don't share ideal factor structure


================================================================================
                           CONCEPTUAL SUMMARY
================================================================================

THE CORE INSIGHT:

  EFA asks: "Can I explain 7 correlated variables with fewer hidden causes?"
  Answer:   "Yes - 2 factors (Order Volume + Unit Characteristics)"

  Regression asks: "Do these hidden causes predict margin?"
  Answer:          "Barely. Only Unit Characteristics matters, and negatively."

  Business implication: Margin decisions are NOT driven by order specs.
                       Look elsewhere (customer tier, relationships, etc.)


================================================================================
                           DOMAIN KNOWLEDGE (Feb 3, 2026)
================================================================================

VARIABLE DEFINITIONS (from product owner)
-----------------------------------------

PRICE TIER SYSTEM:
  - PRICETIERKEY: GUID representing price tier (max 12 tiers currently)
  - Tiers are numerically ordered (1-12) but stored as GUIDs
  - Drives the pricing engine that generates MARGINSYSTEMRECOMMENDED
  - Goal: Use historical data to auto-assign tiers for suppliers who haven't
    manually segmented their customers yet

MARGIN VARIABLES:
  - MARGINSYSTEMRECOMMENDED: What the pricing engine suggested
  - MARGINUSERENTERED: What the sales rep actually set (not varying in this dataset)
  - MARGINACTUAL: Final margin achieved
  - MARGINDIFFERENCE: Delta between recommended and actual
  - Note: In current dataset, no difference between system and user margin

HIERARCHY STRUCTURE:
  - Purchaser: Location → Company (umbrella)
  - Supplier: Location → Company (umbrella)
  - Both use KEY (GUID) and NAME fields

LEAD TIME:
  - Stored as Excel date serial number (looks like 8.64E+11)
  - Convert by formatting as date in Excel
  - Represents quote lead time

TWO PREDICTION PROBLEMS:
  1. Predict PRICETIERKEY - Customer segmentation/tiering
  2. Predict ISWON - Quote win/loss prediction
  These are separate but equally interesting analyses.

MARGIN ENGINE TYPE:
  - "basket" vs "line item" pricing
  - Price breaks grouped by Material Type + Shape Group


================================================================================
                    PRICE TIER VALIDATION ANALYSIS (Feb 3, 2026)
================================================================================

OBJECTIVE
---------
Validate whether existing price tier assignments make sense based on order
characteristics. Identify purchasers who may be in the wrong tier.


DATA USED
---------
  - Dataset: Better_Data_Set_Feb3.csv
  - Suppliers: Sabel Steel, coosasteel.com
  - Date range: Aug 25, 2025 onwards
  - Records: 2,264 quotes
  - Tiers: 15 unique (top 5 analyzed = 89% of data)


METHODOLOGY: HYBRID APPROACH
----------------------------
Combined two techniques:

1. EXPLORATORY FACTOR ANALYSIS (EFA)
   - Compressed 7 order variables into 3 interpretable factors
   - Provides EXPLAINABILITY ("heavy units", "big orders", "high volume")

2. RANDOM FOREST CLASSIFIER
   - Uses factor scores to predict tier assignments
   - Provides ACCURACY in identifying misassignments


THE THREE FACTORS DISCOVERED
----------------------------
Factor 1: UNIT CHARACTERISTICS (42% importance)
  - High loadings: MATERIALUNITWEIGHT (0.98), LINEITEMUNITPRICE (0.94)
  - Interpretation: "Are these heavy, expensive units?"

Factor 2: ORDER VALUE (30% importance)
  - High loadings: LINEITEMTOTALPRICE (0.97), ESTIMATETOTALPRICE (0.70)
  - Interpretation: "Is this a big dollar order?"

Factor 3: ORDER VOLUME (28% importance)
  - High loadings: ESTIMATETOTALQUANTITY (1.00), QTYPERLINEITEM (0.60)
  - Interpretation: "Is this a high quantity order?"


KEY FINDINGS
------------
1. All 3 factors significantly discriminate between tiers (p < 0.001)
   - Unit Characteristics has the strongest effect (η² = 0.138)

2. Model accuracy: 57% (using factors) vs 65% (using raw variables)
   - Trade-off: Lost 8% accuracy, gained interpretability

3. Tier profiles discovered:
   - Tier_2 (0% win rate): LOW unit characteristics
   - Tier_3 (44% win rate): HIGH unit characteristics + HIGH volume

4. Flagged purchasers (potential misassignments):
   - davismachineworks.com: 0% win rate, Tier_3 → suggests Tier_1
   - TYSONMETALWORKS.COM: 0% win rate, HIGH unit characteristics
   - wescoweld.com: 8% win rate, Tier_4 → suggests Tier_1
   - cahabatruck.com: 100% win rate (leaving money on table?)
*** There may be a business reason to describe the leakage ***

OUTPUT FILES
------------
  outputs/efa_tier_analysis/
    - factor_scores.csv          : Factor scores for each quote
    - tier_factor_profiles.csv   : Mean factors by tier
    - anova_results.csv          : Statistical significance tests

  outputs/hybrid_validation/
    - recommendations.csv        : Actionable items
    - purchaser_analysis.csv     : Full purchaser breakdown
    - quote_level_results.csv    : Every quote with prediction
    - summary_report.txt         : Human-readable findings


SCRIPTS TO RUN
--------------
  1. python efa_price_tier.py               # Generate factor scores
  2. python price_tier_validation_hybrid.py # Run hybrid validation


================================================================================
                                    END
================================================================================
